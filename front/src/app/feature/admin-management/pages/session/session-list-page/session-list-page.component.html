<app-navbar-event-page
  [eventUrl]="eventUrl"
  [eventId]="eventId"
  [eventName]="eventName"
  [teamId]="teamId">
</app-navbar-event-page>

<div class="px-0 sm:px-10 md:px-10 lg:px-10 xl:px-20 2xl:px-70 w-full">
  <main class="flex">
    <section class="flex-1 p-4">
      @if (isLoading) {
        <div class="flex justify-center items-center h-40">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
      }

      @if (error) {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
          <p>{{ error }}</p>
        </div>
      }

      @if (!isLoading && !error) {
        <form class="mx-auto" (ngSubmit)="onSubmit($event)">
          <article class="w-full items-center bg-white shadow-md rounded-lg py-4">
            @if (totalSessions !== 0) {
              <section class="px-4 pb-4">
                <div class="flex items-center gap-3">
                  <div class="relative flex-1">
                    <input
                      type="text"
                      name="searchInput"
                      placeholder="Search for proposals..."
                      class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      (input)="onSearch($event)"
                      [value]="searchTerm"
                    />
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                      <i class="material-icons text-lg">search</i>
                    </span>
                  </div>

                  <app-button-grey
                    type="button"
                    [materialIcon]="'tune'"
                    customTextClass="text-gray-600 hover:text-gray-600"
                    class="flex-shrink-0 rounded-md text-base items-center gap-2 bg-white hover:bg-gray-100 border border-gray-300 cursor-pointer shadow-sm">
                    Filters
                  </app-button-grey>

                  <app-button-grey
                    type="button"
                    [materialIcon]="'swap_vert'"
                    customTextClass="text-gray-600 hover:text-gray-600"
                    class="flex-shrink-0 rounded-md text-base items-center gap-2 bg-white hover:bg-gray-100 border border-gray-300 cursor-pointer shadow-sm">
                    Sort
                  </app-button-grey>

                  <app-button-grey
                    type="button"
                    [materialIcon]="'download'"
                    customTextClass="text-gray-600 hover:text-gray-600"
                    class="flex-shrink-0 rounded-md text-base items-center gap-2 bg-white hover:bg-gray-100 border border-gray-300 cursor-pointer shadow-sm">
                      Export
                  </app-button-grey>
                </div>
              </section>
            }
            @if (isLoadingSessions) {
              <div class="flex justify-center items-center h-32 px-4">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <span class="ml-2 text-gray-600">Chargement des sessions...</span>
              </div>
            } @else {
              <div class="relative overflow-x-auto sm:rounded-lg">
                <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                  @if (totalSessions !== 0) {
                    <thead class="text-xs text-gray-700 bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                      <th scope="col" class="p-4">
                        <div class="flex items-center">
                          <input
                            id="checkbox-all-search"
                            type="checkbox"
                            [checked]="selectAll"
                            (change)="toggleSelectAll()"
                            class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 dark:focus:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                          <label for="checkbox-all-search" class="sr-only">checkbox</label>
                        </div>
                      </th>
                      <th scope="col" class="px-2 py-3 font-normal">
                        {{ totalSessions }} proposition{{ totalSessions > 1 ? 's' : '' }}
                      </th>
                    </tr>
                    </thead>
                  }
                  <tbody>
                    @if (paginatedSessions.length === 0) {
                      <tr class="bg-white">
                        <td colspan="2" class="px-4 py-8 text-center text-gray-500">
                          @if (searchTerm) {
                            <div class="flex flex-col items-center">
                              <i class="material-icons text-4xl text-gray-300 mb-2">search_off</i>
                              <p class="text-lg font-medium text-gray-600">Aucune session trouvée</p>
                              <p class="text-sm text-gray-500">pour "{{ searchTerm }}"</p>
                            </div>
                          } @else {
                            <div class="flex flex-col items-center">
                              <i class="material-icons text-4xl text-gray-300 mb-2">event_note</i>
                              <p class="text-lg font-medium text-gray-600">Aucune session disponible</p>
                              <p class="text-sm text-gray-500">Importez des sessions pour commencer</p>
                            </div>
                          }
                        </td>
                      </tr>
                    } @else {
                      @for (session of paginatedSessions; track session.id) {
                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer"
                            (click)="onRowClick(session.id!, $event)">
                          <td class="w-4 p-4" (click)="$event.stopPropagation()">
                            <div class="flex items-center">
                              <input
                                [id]="'checkbox-table-search-' + session.id"
                                type="checkbox"
                                [checked]="isSessionSelected(session.id)"
                                (change)="toggleSessionSelection(session.id!)"
                                (click)="$event.stopPropagation()"
                                class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500">
                              <label [for]="'checkbox-table-search-' + session.id" class="sr-only">checkbox</label>
                            </div>
                          </td>
                          <th scope="row" class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                            <div class="flex min-w-0 gap-x-2">
                              <div class="min-w-0 flex-auto">
                                <p class="text-sm/6 text-gray-900 font-medium">
                                  {{ session.title || 'Titre non défini' }}
                                </p>
                                <p class="truncate text-xs/5 text-gray-500">
                                  par {{ formatSpeakers(session.speakers) }}
                                </p>
                              </div>
                            </div>
                          </th>
                        </tr>
                      }
                    }
                  </tbody>
                </table>

                @if (totalPages > 1) {
                  <nav class="flex items-center flex-column flex-wrap md:flex-row justify-between p-4" aria-label="Table navigation">
                    <span class="text-sm font-normal text-gray-600 dark:text-gray-400 mb-4 md:mb-0 block w-full md:inline md:w-auto">
                      Affichage {{ (currentPage - 1) * itemsPerPage + 1 }}-{{ Math.min(currentPage * itemsPerPage, totalSessions) }} sur {{ totalSessions }} résultats
                    </span>
                    <ul class="inline-flex -space-x-px rtl:space-x-reverse text-sm h-8">
                      <li>
                        <button
                          type="button"
                          (click)="goToPage(currentPage - 1)"
                          [disabled]="currentPage === 1"
                          [class]="currentPage === 1 ?
                            'flex items-center justify-center px-3 h-8 ms-0 leading-tight text-gray-300 bg-gray-100 border border-gray-300 rounded-s-lg cursor-not-allowed' :
                            'flex items-center justify-center px-3 h-8 ms-0 leading-tight text-gray-500 bg-white border border-gray-300 rounded-s-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white cursor-pointer'">
                          Précédent
                        </button>
                      </li>

                      @for (pageNum of pageNumbers; track pageNum) {
                        <li>
                          <button
                            type="button"
                            (click)="goToPage(pageNum)"
                            [class]="pageNum === currentPage ?
                              'flex items-center justify-center px-3 h-8 text-blue-600 border border-gray-300 bg-blue-50 hover:bg-blue-100 hover:text-blue-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white' :
                              'flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white cursor-pointer'">
                            {{ pageNum }}
                          </button>
                        </li>
                      }

                      <li>
                        <button
                          type="button"
                          (click)="goToPage(currentPage + 1)"
                          [disabled]="currentPage === totalPages"
                          [class]="currentPage === totalPages ?
                            'flex items-center justify-center px-3 h-8 leading-tight text-gray-300 bg-gray-100 border border-gray-300 rounded-e-lg cursor-not-allowed' :
                            'flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-e-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white cursor-pointer'">
                          Suivant
                        </button>
                      </li>
                    </ul>
                  </nav>
                }
              </div>
            }
          </article>
        </form>
      }
    </section>
  </main>
</div>
<app-session-detail-page
  [session]="selectedSessionForDetail"
  [format]="selectedFormat"
  [category]="selectedCategory"
  [isOpen]="isModalOpen"
  (closeEvent)="closeSessionDetail()"
  (editEvent)="onEditSession($event)">
</app-session-detail-page>
