<app-navbar-session-page
  [eventUrl]="eventUrl"
  [eventId]="eventId"
  [eventName]="eventName"
  [sessionId]="sessionId">
</app-navbar-session-page>

<div class="px-5 sm:px-5 md:px-5 lg:px-5 xl:px-20 2xl:px-70 w-full">
  <main class="flex justify-center p-4">
    @if (session) {
      <div class="relative bg-white rounded-lg shadow-xl max-w-7xl w-full">

        <div class="flex items-center justify-between p-4 border-b border-gray-200">
          <h2 [id]="'modal-title-' + session.id"
              class="text-lg font-medium text-gray-900 flex-1 mr-4">
            {{ session.title }}
          </h2>
          <app-button-grey
            type="button"
            [materialIcon]="'edit_square'"
            customTextClass="text-gray-600 hover:text-gray-600"
            class="flex-shrink-0 rounded-md text-base items-center gap-2 bg-white hover:bg-gray-100 border border-gray-300 cursor-pointer shadow-sm"
            (click)="onEditSession()">
            Edit
          </app-button-grey>
        </div>

        <div class="p-6 space-y-6 border-b border-gray-200">

          <section class="flex items-start sm:items-center justify-between p-4 gap-4 flex-col sm:flex-row">
            <div class="flex items-center flex-wrap gap-2 min-w-0 flex-1">
              @if (session.speakers && session.speakers.length > 0) {
                @for (speaker of session.speakers; track speaker.name) {
                  <div (click)="openItemDetail(speaker.id)" class="inline-flex items-center gap-3 border border-gray-300 rounded-full px-2 py-1 bg-white shadow-sm cursor-pointer">
                    <div class="flex-shrink-0">
                      <img
                        [src]="speaker.picture || 'img/profil-picture.svg'"
                        class="h-10 w-10 rounded-full object-cover border-2 border-gray-100"
                        [alt]="'Photo de ' + speaker.name"
                        referrerpolicy="no-referrer"
                        (error)="onImageError($event)">
                    </div>

                    <div class="flex-1 min-w-0">
                      <h4 class="font-medium text-gray-900 text-sm truncate">
                        {{ speaker.name }}
                      </h4>
                    </div>
                  </div>
                }
              }
            </div>
          </section>

          <div class="text-gray-700 p-3 rounded-md">
            @if (session.abstractText) {
              <p class="whitespace-pre-wrap">{{ session.abstractText }}</p>
            } @else {
              <p class="text-gray-500 italic">No description available</p>
            }
          </div>

          @if (format || (session.formats && session.formats.length > 0)) {
            <div>
              <h4 class="font-base font-medium text-gray-900 mb-2">Formats</h4>
              <div class="flex flex-wrap gap-2">
                @if (format) {
                  <div class="inline-flex items-center text-gray-700 text-sm py-1 px-3">
                    {{ format.name }}
                  </div>
                }
              </div>
            </div>
          }

          @if (category || (session.categories && session.categories.length > 0)) {
            <div>
              <h4 class="font-base font-medium text-gray-900 mb-2">Categories</h4>
              <div class="flex flex-wrap gap-2">
                @if (category) {
                  <div class="inline-flex items-center text-gray-700 text-sm py-1 px-3">
                    {{ category.name }}
                  </div>
                }
              </div>
            </div>
          }

          <div class="flex flex-wrap gap-3">
            @if (session.level) {
              <div class="inline-flex items-center bg-blue-50 text-blue-700 border border-blue-200 text-sm px-3 py-1 rounded-lg">
                {{ formatLevel(session.level) }}
              </div>
            }

            @if (session.languages && session.languages.length > 0) {
              @for (language of session.languages; track language) {
                <div class="inline-flex items-center bg-gray-100 text-gray-700 border border-gray-200 text-sm py-1 px-3 rounded-lg">
                  {{ formatLanguage(language) }}
                </div>
              }
            }
          </div>
        </div>

        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-base font-medium text-gray-900">Schedule</h3>

            @if (isEditingSchedule) {
              <div class="flex gap-2">
                <app-button-grey
                  type="button"
                  (click)="onCancelScheduleEdit()"
                  customTextClass="text-gray-600 hover:text-gray-600"
                  class="flex-shrink-0 rounded-md text-base items-center gap-2 bg-white hover:bg-gray-100 border border-gray-300 cursor-pointer shadow-sm">
                  Cancel
                </app-button-grey>
                <app-button-green-actions
                  type="button"
                  (click)="onSaveSchedule()"
                  [materialIcon]="'check'">
                  @if (isUpdatingSchedule) {
                    <span>Saving...</span>
                  } @else {
                    <span>Save</span>
                  }
                </app-button-green-actions>
              </div>
            }

            @if (scheduleError) {
              <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                <p class="text-sm text-red-600">{{ scheduleError }}</p>
              </div>
            }

            @if (scheduleFormErrors.length > 0) {
              <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
                @for (error of scheduleFormErrors; track error) {
                  <p class="text-sm text-red-600">{{ error }}</p>
                }
              </div>
            }

            @if (isEditingSchedule) {
              <form [formGroup]="scheduleForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="space-y-2">
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input
                      id="start-date"
                      type="date"
                      formControlName="startDate"
                      [placeholder]="getStartDateValue()"
                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Start Time & Duration</label>
                    <div class="flex">
                      <input
                        type="time"
                        formControlName="startTime"
                        [placeholder]="getStartTimeValue()"
                        class="rounded-none rounded-s-lg bg-gray-50 border text-gray-900 leading-none focus:ring-blue-500 focus:border-blue-500 block flex-1 w-full text-sm border-gray-300 p-2.5">

                      <div class="relative">
                        <button
                          type="button"
                          class="border-s-0 shrink-0 z-10 inline-flex items-center py-2.5 px-4 text-sm font-medium text-center text-gray-900 bg-gray-100 border border-gray-300 rounded-e-lg hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100"
                          (click)="showDurationDropdown = !showDurationDropdown">
                          {{ selectedDuration }} min
                          <svg class="w-2.5 h-2.5 ms-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                          </svg>
                        </button>

                        @if (showDurationDropdown) {
                          <div class="absolute top-full right-0 z-20 bg-white divide-y divide-gray-100 rounded-lg shadow-lg w-36 border">
                            <ul class="py-2 text-sm text-gray-700">
                              @for (duration of durations; track duration.value) {
                                <li>
                                  <button
                                    type="button"
                                    (click)="onDurationSelect(duration.value); showDurationDropdown = false"
                                    class="inline-flex w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    {{ duration.label }}
                                  </button>
                                </li>
                              }
                            </ul>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                </div>

                <div class="space-y-2">
                  <label for="track-select" class="block text-sm font-medium text-gray-700">Track/Room</label>
                  @if (availableTracks.length > 0) {
                    <select
                      id="track-select"
                      formControlName="track"
                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                      <option value="">Select a track...</option>
                      @for (track of availableTracks; track track) {
                        <option [value]="track">{{ track }}</option>
                      }
                    </select>
                  } @else {
                    <input
                      id="track-input"
                      type="text"
                      formControlName="track"
                      [placeholder]="getTrackPlaceholder()"
                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                  }
                </div>
              </form>
            } @else {
              @if(hasScheduleInfo()) {
                <p class="text-sm text-gray-700" [innerHTML]="formatCompleteSessionInfo()"></p>
              } @else {
                <p class="text-sm text-gray-500 italic">
                  Schedule information not yet available
                </p>
              }
            }
          </div>
        </div>
      </div>
    }
  </main>
</div>
